{% extends "base.html" %}

{% block title %}Issue Credential - Blockchain Identity Verification{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Issue Credential</h1>
    <p>Create and issue a verifiable credential to a user</p>
</div>

<div class="form-container">
    <form id="issue-credential-form">
        <div class="form-group">
            <label for="issuer-did">Issuer DID *</label>
            <input type="text" id="issuer-did" name="issuer_did" required placeholder="did:identity:...">
            <small>Enter the DID of the issuer (must have issuer role)</small>
        </div>
        
        <div class="form-group">
            <label for="recipient-did">Recipient DID *</label>
            <input type="text" id="recipient-did" name="recipient_did" required placeholder="did:identity:...">
            <small>Enter the DID of the recipient</small>
        </div>
        
        <div class="form-group">
            <label for="credential-type">Credential Type *</label>
            <input type="text" id="credential-type" name="credential_type" required placeholder="e.g., Diploma, Certificate, License">
        </div>
        
        <div class="form-group">
            <label for="credential-data">Credential Data (JSON) *</label>
            <textarea id="credential-data" name="credential_data" required rows="6" placeholder='{"degree": "Bachelor of Science", "field": "Computer Science", "year": "2024"}'></textarea>
            <small>Enter credential data as JSON object</small>
        </div>
        
        <button type="submit" class="btn btn-primary">Issue Credential</button>
    </form>
</div>

<div id="result" class="result-container" style="display: none;">
    <h3>Credential Issued Successfully!</h3>
    <div class="result-box">
        <p><strong>Credential ID:</strong> <span id="result-id"></span></p>
        <p><strong>Type:</strong> <span id="result-type"></span></p>
        <p><strong>Issuer:</strong> <span id="result-issuer"></span></p>
        <p><strong>Recipient:</strong> <span id="result-recipient"></span></p>
        <p><strong>Credential Hash:</strong> <span id="result-hash" class="hash-text"></span></p>
        <p><strong>Issued At:</strong> <span id="result-date"></span></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('issue-credential-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let credentialData;
        try {
            credentialData = JSON.parse(document.getElementById('credential-data').value);
        } catch (error) {
            alert('Invalid JSON format in credential data');
            return;
        }
        
        const formData = {
            issuer_did: document.getElementById('issuer-did').value,
            recipient_did: document.getElementById('recipient-did').value,
            credential_type: document.getElementById('credential-type').value,
            credential_data: credentialData
        };
        
        try {
            const response = await fetch('/api/credential/issue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                const cred = data.credential;
                document.getElementById('result-id').textContent = cred.credential_id;
                document.getElementById('result-type').textContent = cred.credential_type;
                document.getElementById('result-issuer').textContent = cred.issuer_name;
                document.getElementById('result-recipient').textContent = cred.recipient_name;
                document.getElementById('result-hash').textContent = cred.credential_hash;
                document.getElementById('result-date').textContent = new Date(cred.issued_at * 1000).toLocaleString();
                document.getElementById('result').style.display = 'block';
                document.getElementById('issue-credential-form').reset();
                
                // Auto mine block
                fetch('/api/blockchain/mine', { method: 'POST' });
            } else {
                alert('Error: ' + (data.error || 'Failed to issue credential'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
</script>
{% endblock %}

